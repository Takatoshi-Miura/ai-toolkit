# Android PRレビューガイド

Android プロジェクト（Kotlin/Java/XML）のPull Requestをレビューする際の観点と手順を定義します。

## 前提条件

- レビュー対象のPR URLまたはローカル差分が提供されていること
- PRのブランチにチェックアウト済み、またはチェックアウト可能であること

## 手順

### Phase 1: 情報収集

1. **追加情報の確認（任意）**
   - PBI（Product Backlog Item）のURL
   - 概要設計書のURL
   - テスト項目書のURL
   - Figmaデザインのリンク

2. **PR/差分情報の取得**

   **GitHub PRの場合:**
   ```bash
   # PR情報の取得
   gh pr view <PR番号> --repo owner/repo

   # 変更差分の取得
   gh pr diff <PR番号> --repo owner/repo
   ```

   **ローカル差分の場合:**
   ```bash
   # ステージング済み + 未ステージングの差分
   git diff HEAD

   # または特定ブランチとの差分
   git diff <base-branch>..HEAD
   ```

3. **追加資料の読み取り（提供された場合）**
   - Google Driveの場合: `g_drive_read_file` で読み取り
   - Redmineの場合: `redmine_get_detail` で読み取り

### Phase 2: Androidコードレビュー

4. **変更ファイルの分類**

   変更されたファイルを以下のカテゴリに分類:

   | カテゴリ | ファイルパターン | 重点確認ポイント |
   |---------|-----------------|-----------------|
   | Activity/Fragment | `*Activity.kt`, `*Fragment.kt` | ライフサイクル管理 |
   | ViewModel | `*ViewModel.kt` | 状態管理、LiveData/Flow |
   | Repository/UseCase | `*Repository.kt`, `*UseCase.kt` | データ層設計 |
   | UI/Compose | `*.xml`, `*Composable.kt` | UI構造、アクセシビリティ |
   | DI | `*Module.kt`, `*Component.kt` | 依存関係 |
   | テスト | `*Test.kt`, `*AndroidTest.kt` | カバレッジ、品質 |
   | ビルド設定 | `*.gradle`, `*.kts` | 依存関係、設定 |

5. **レビュー観点チェック**

   下記「Android PRレビュー観点」に従い、特にAndroid固有項目を重点的にレビュー。

### Phase 3: レビュー結果の出力

6. **レビュー結果をユーザーに共有**

   下記「出力テンプレート」に従って結果を出力。

---

## Android PRレビュー観点

### 1. 変更の目的・スコープ
* PRタイトル・説明と実装内容が一致している
* 変更範囲が目的に対して最小限である
* 不要な変更（インデント変更・無関係なリファクタ）が含まれていない
* 削除されたコード・関数の理由が明確で、他箇所への悪影響がない

### 2. 仕様・ロジック・データ整合性（デグレ防止含む）
* 実装が Issue・仕様書・PR説明と整合している
* 推測による実装や曖昧な処理がない
* データフロー（登録→更新→削除等）に矛盾がない
* null・空値・境界値（最大/最小）を適切に処理している
* 既存画面や機能を壊していない（デグレなし）
* 条件分岐や例外処理を削除した影響が適切に考慮されている
* API・ライブラリ変更による互換性が保たれている

### 3. Androidプラットフォーム／ライフサイクル
* Activity / Fragment / Service 等のライフサイクルを正しく扱っている
* 画面回転・バックグラウンド復帰・低メモリなど OS イベントで安定動作する
* Context, Drawable, String 等のリソースが適切に管理されている（リークなし）
* Jetpack アーキテクチャコンポーネントの利用が推奨パターンに沿っている
* Main/IO スレッド切り替えが適切
* プロセス終了やマルチウィンドウなどで状態が正しく保持・復元される
* Coroutine とライフサイクルの連携が適切（キャンセル漏れがない）

### 4. 画面遷移・状態管理・非同期処理

#### 4.1 画面遷移
* 画面遷移・戻る動作・状態遷移に一貫性がある
* Bundle / Intent / Navigation Args 等のデータ受け渡しが安全
* 二重タップ・多重遷移が防止されている
* バックスタック復帰時に状態が正しく維持される
* Deep Link 対応が適切（該当する場合）

#### 4.2 登録・更新フロー
* ローディング状態の管理が適切
* 二重送信防止が実装されている（ボタン disable、リクエスト重複防止等）
* 成功・失敗時の UI 遷移とエラーハンドリングが適切
* オフライン時の処理が考慮されている（該当する場合）

#### 4.3 非同期処理とキャンセル
* 適切な Coroutine スコープ（lifecycleScope など）が選択されている
* ライフサイクル終了時に処理がキャンセルされている
* finally / onCancellation など後処理が保証されている
* 長時間処理にタイムアウトが設定されている（必要な場合）
* 不正状態・レースコンディションが発生しない設計になっている

#### 4.4 入力・フォーカス管理
* 入力値の検証・整形が適切なタイミングで行われている
* ソフトキーボードの表示・非表示制御が自然
* 入力エラー時に適切なフィードバックが行われる
* Galaxy端末のIME(キーボード入力)で問題が発生しないか
  - 予測変換・自動補完の挙動が正常
  - 入力確定タイミング(composing状態からcommit時)の処理が適切
  - テキスト入力中のフィルタリング・リアルタイム検証が正しく動作
  - 長押しによる特殊文字入力・記号入力が正常に機能

#### 4.5 フォアグラウンド復帰時
* 復帰時に必要なデータ再読み込みが行われている
* 認証状態の確認・再同期が適切
* UI状態（スクロール位置・入力中データ等）が復元されている

### 5. UI/UX・ユーザビリティ
* エラーメッセージの文言が仕様通りで正確
* ローディング・エラー表示のタイミングが自然（チラつきなどがない）
* ボタンの活性/非活性制御が適切
* エラー状態のクリアタイミング（再試行時・遷移時）が適切

### 6. 設計・可読性・保守性
* 命名・フォーマット・ディレクトリ構成が一貫している
* 冗長なロジック・重複コードがない（DRY）
* 責務分離が適切（UI・ドメイン・データ層の役割が明確）
* 例外処理の扱いが適切（層を跨がず、握る箇所が適切）
* 将来的な拡張性・変更容易性が考慮されている
* コメント・ドキュメントが必要十分に記述されている
* 技術的負債を増やしていない、または改善が行われている

### 7. テスト
* テストコードが存在し、主要分岐・エッジケースをカバーしている
* null / 最大値 / 最小値 / 空データなど境界値テストが含まれている
* 既存テストが仕様変更に合わせて更新されている
* デグレ防止に役立つテスト（回帰テスト等）が整備されている

### 8. セキュリティ
* パスワード・トークンなど機密情報がログや画面に露出していない
* 機密データの保存が暗号化されている（SharedPreferences・DB等）
* 入力値が適切に検証・サニタイズされている
* 認証・認可チェックが適切
* セキュア通信（HTTPS / ピンニング）に問題がない

### 9. パフォーマンス・リソース
* メインスレッドで重い処理を実行していない
* 不必要な再描画・再計算が発生していない
* RecyclerViewの最適化（ViewHolder再利用・DiffUtil等）が行われている
* 画像読み込みが最適化されている（キャッシュ・リサイズ等）
* メモリ使用量が適切、大量データ処理でOOMの危険がない
* メモリリーク（Context保持、リスナー未解除等）が発生していない
* ネットワーク通信が最適化されている（キャッシュ・バッチ等）

### 10. その他（自由な発想でのレビュー）
以下の観点を参考に、上記カテゴリーに当てはまらない気づきや改善提案を自由に行う:
* 可読性・理解しやすさの改善余地
* より良い実装方法やライブラリの提案
* レアケース・エッジケースの漏れ
* ダークモード対応
* 他画面・他機能との整合性
* ビルド・テスト時間への影響

---

## 出力テンプレート

```markdown
## Androidコードレビュー結果

### 概要
- **PR/差分**: [PR番号 or ブランチ名]
- **変更ファイル数**: X件
- **Androidファイル内訳**: Kotlin: X件, Java: X件, XML: X件, その他: X件

---

### レビューサマリー

| 観点 | 評価 | 指摘件数 | 重要度高 |
|------|------|----------|----------|
| ライフサイクル管理 | ⚪/△/✕ | X件 | X件 |
| 画面遷移・状態管理 | ⚪/△/✕ | X件 | X件 |
| 非同期処理 | ⚪/△/✕ | X件 | X件 |
| UI/UX | ⚪/△/✕ | X件 | X件 |
| セキュリティ | ⚪/△/✕ | X件 | X件 |
| パフォーマンス | ⚪/△/✕ | X件 | X件 |
| テスト | ⚪/△/✕ | X件 | X件 |

---

### 指摘事項

#### [MUST] 修正必須
1. **[ファイル名:行番号]** - [観点カテゴリ]
   - 問題: [具体的な問題点]
   - 理由: [なぜ問題なのか]
   - 修正案: [具体的な修正方法]

#### [SHOULD] 修正推奨
1. **[ファイル名:行番号]** - [観点カテゴリ]
   - 問題: [具体的な問題点]
   - 理由: [なぜ問題なのか]
   - 修正案: [具体的な修正方法]

#### [COULD] 改善提案
1. **[ファイル名:行番号]** - [観点カテゴリ]
   - 提案: [改善内容]
   - 効果: [改善による効果]

---

### 良い点
- [認めるべき良い実装ポイント]

---

### 確認事項
- [ ] [確認が必要な事項]
```
