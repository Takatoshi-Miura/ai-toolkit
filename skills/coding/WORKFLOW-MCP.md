# MCP開発ワークフロー

MCP開発のスペシャリストとして、MCPサーバーの新規作成・ツール追加・ツール更新を支援する。
参考実装として `~/Documents/Git/MCP-GoogleDrive` のパターンを踏襲する。

## TodoWrite登録

```json
[
  {"content": "Phase 1: 作業タイプ選択・要件ヒアリング", "activeForm": "要件をヒアリング中", "status": "pending"},
  {"content": "Phase 2: 設計計画", "activeForm": "設計計画を策定中", "status": "pending"},
  {"content": "Phase 3: 実装", "activeForm": "コードを実装中", "status": "pending"},
  {"content": "Phase 4: 確認・完了", "activeForm": "確認・完了処理中", "status": "pending"}
]
```

---

## Phase 1: 作業タイプ選択・要件ヒアリング

### 1-1. 作業タイプの選択

AskUserQuestionで選択:

| # | 作業タイプ | 説明 |
|---|-----------|------|
| 1 | 新規サーバー作成 | MCPサーバー全体を新規構築 |
| 2 | ツール追加 | 既存サーバーに新しいツールを追加 |
| 3 | ツール更新 | 既存ツールを修正・改善 |

### 1-2. 要件ヒアリング（作業タイプ別）

#### 新規サーバー作成の場合

AskUserQuestionで収集:

| 項目 | 必須 | 例 |
|------|------|-----|
| サーバー名 | ✅ | mcp-google-calendar |
| 実行コマンド | ✅ | node / uv |
| 作成先ディレクトリ | ✅ | 絶対パス |
| MCPサーバーの機能 | ✅ | 詳細な機能要件 |
| 提供するツール | ✅ | ツール名と概要 |
| 参考ドキュメントURL | ❌ | 公式ドキュメント等 |
| 認証情報 | ❌ | OAuth、API Key等 |

#### ツール追加の場合

AskUserQuestionで収集:

| 項目 | 必須 | 例 |
|------|------|-----|
| MCPサーバーのパス | ✅ | ~/Documents/Git/MCP-GoogleDrive |
| ツール名 | ✅ | g_drive_merge_cell |
| ツールの説明（英語） | ✅ | Merge specified cell ranges |
| 機能概要 | ✅ | 何をするツールか |
| 引数の仕様 | ✅ | 引数名、型、必須/任意、説明 |
| 参考コード | ❌ | 似た既存ツール名 |
| API仕様 | ❌ | ドキュメントURL |

#### ツール更新の場合

AskUserQuestionで収集:

| 項目 | 必須 | 例 |
|------|------|-----|
| MCPサーバーのパス | ✅ | ~/Documents/Git/MCP-GoogleDrive |
| 更新対象ツール名 | ✅ | ツール名 or 「一覧表示」 |
| 変更したい点 | ✅ | パラメータ追加、ロジック修正等 |
| 変更の理由 | ✅ | なぜ変更が必要か |
| 期待する動作 | ✅ | 変更後の挙動 |

**ツール一覧の自動表示**: 「一覧表示」が選ばれた場合、以下で既存ツールを抽出:

```bash
python3 skills/coding/scripts/analyze_mcp_server.py {server_path}
```

### 1-3. 要件確認

収集した情報を表形式で整理しユーザーに確認。修正があれば再収集。

**成功確認**: ユーザーが要件を承認 → Phase 2へ

---

## Phase 2: 設計計画

### 2-1. 参考実装の調査（新規サーバー作成時）

`~/Documents/Git/MCP-GoogleDrive` の実装パターンを調査:
- ディレクトリ構造、package.json、依存関係
- 主要ファイルの実装パターン分析

### 2-2. Plan サブエージェントの呼び出し

Taskツールで `Plan` サブエージェントを起動し、作業タイプに応じた計画を立案:

**新規サーバー作成**:
- ディレクトリ構造の詳細設計
- 必要なファイル一覧と役割
- 各ツールの実装方針
- 依存パッケージの選定
- 認証・セキュリティ考慮事項

**ツール追加**:
- 既存コードベースの調査（ツール定義、サービスロジック、型定義、エラーハンドリング）
- ツール定義の実装方針（zodスキーマ、バリデーション）
- サービスロジックの実装方針
- 型定義の追加

**ツール更新**:
- 対象ツールの詳細分析（定義、サービス、型、依存関係）
- 変更が必要なファイルと箇所の特定
- 具体的な変更内容（差分形式）
- 後方互換性の評価（Breaking Changesの有無）

### 2-3. ユーザー承認

計画をユーザーに提示し承認を得る。ツール更新時はBreaking Changesがある場合、後方互換性の影響を明示。

**成功確認**: ユーザーが設計計画を承認 → Phase 3へ

---

## Phase 3: 実装

### 3-1. 新規サーバー作成の場合

1. ディレクトリとプロジェクト構造を作成
2. package.json / プロジェクト設定ファイルを生成（`@modelcontextprotocol/sdk` 必須）
3. メインの実装ファイルを作成（エントリポイント、MCPサーバー初期化、ツール実装）
4. 設定ファイルを作成（tsconfig.json / pyproject.toml / .gitignore）
5. READMEを作成（日本語）
6. 依存パッケージをインストール（`npm install` / `uv sync`）
7. ビルド（TypeScriptの場合: `npm run build`）

### 3-2. ツール追加の場合

1. サービスロジックの実装（Editで既存サービスファイルにメソッド追加）
2. ツール定義の追加（Editでtools/*.tools.tsに追加）
   - zodスキーマでパラメータ定義（describeは英語）
   - 既存ツールと同じフォーマットに従う
3. 型定義の追加（必要な場合）
4. README更新（ツール一覧セクションに追加）

### 3-3. ツール更新の場合

1. サービスロジックの更新（Editで対象メソッドを更新）
2. ツール定義の更新（zodスキーマ変更、ハンドラーロジック変更）
3. 型定義の更新（必要な場合）
4. README更新（パラメータ変更・使用例の更新）

### 実装共通ルール

- MCP-GoogleDriveの実装パターンを踏襲
- zodスキーマのdescribeは英語（MCP仕様）
- コメントは日本語可
- 既存のエラーハンドリングパターンを維持
- セキュリティ（API Key等）の取り扱いに注意

**成功確認**: 実装完了・ビルド成功 → Phase 4へ

---

## Phase 4: 確認・完了

### 4-1. 実装結果の報告

変更・作成したファイル一覧と変更概要を報告。

### 4-2. Claude Desktop設定の案内（新規サーバー作成時）

`~/Library/Application Support/Claude/claude_desktop_config.json` の `mcpServers` セクションへの追加方法を案内。

### 4-3. 動作確認手順の案内

- ビルド手順（`npm run build` / `uv sync`）
- Claude Desktop再起動
- ツールの動作確認ポイント
- ツール更新時は後方互換性の確認も含める

### 4-4. 次のステップ提案

- 機能追加: `/coding` → MCP開発 → ツール追加
- デバッグ方法の案内
- リポジトリ公開する場合の推奨事項

---

## エラーハンドリング

| エラー | 対応 |
|-------|------|
| ディレクトリが存在しない | パスの確認を依頼 |
| ツールが見つからない | `analyze_mcp_server.py` でツール一覧を表示し確認 |
| npm install / ビルド失敗 | エラーメッセージ分析、対処法提示 |
| 既存ツール名と重複 | 別名の提案、上書き確認 |
| 後方互換性の問題 | 互換性維持オプションの提案 |
| README更新失敗 | セクション構造の再確認、手動更新の案内 |

## 注意事項

- 作成・変更前に必ずユーザーの承認を得る
- 既存ファイルの上書き前に確認する
- READMEは日本語で作成・更新
- 参考実装は `~/Documents/Git/MCP-GoogleDrive` で固定
- Planサブエージェントにコードベース調査と設計を一括で任せる
