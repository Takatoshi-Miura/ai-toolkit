# 実装タスク 詳細リファレンス

各Phaseの詳細な実行手順を記載します。

---

## Phase 1: 情報収集

```
Phase 1 チェックリスト：
- [ ] ユーザーへの質問（必須項目）
- [ ] ユーザーへの質問（任意項目）
- [ ] Redmineチケット読み取り
- [ ] 概要設計書・テスト項目書読み取り（指定がある場合）
- [ ] 情報の整理・次Phaseへの引き継ぎ
```

### 1-1. ユーザーへの質問

AskUserQuestionツールを使用して、以下の情報を収集する：

```
必須項目:
- RedmineチケットURL

任意項目:
- 概要設計書のURL
- テスト項目書のURL（シート名指定可能）
- 実装したいこと・その他共有事項
```

### 1-2. 外部データの読み取り

収集した情報に基づき、以下を読み取る：

**Redmineチケット**:
- `/redmine-skill` で読み取り
- チケット番号、タイトル、詳細を取得

**概要設計書・テスト項目書**（指定がある場合）:
- `/google-drive-skill` で読み取り

### 1-3. 情報の整理

収集した情報をTodoWriteの補足コメントや会話内で整理し、次のPhaseに引き継ぐ。

---

## Phase 2: 実装計画

```
Phase 2 チェックリスト：
- [ ] Plan サブエージェントの起動
- [ ] 不明点のユーザー確認（解消まで繰り返し）
- [ ] 既存の類似実装パターン調査
- [ ] 修正対象ファイルの特定
- [ ] 実装方針の策定
- [ ] 実装計画の出力
- [ ] ユーザー承認の取得
```

### 2-1. Plan サブエージェントの呼び出し

Taskツールで `Plan` サブエージェントを起動：

```
subagent_type: "Plan"
prompt: |
  以下の情報に基づいて実装計画を立ててください。

  ## 実装内容
  {Redmineチケットの詳細、概要設計書の内容}

  ## 参照情報
  - CLAUDE.mdのパス: {プロジェクトのCLAUDE.md}
  - 概要設計書: {概要設計書の内容}

  ## 作成してほしいもの
  1. 不明点があればユーザーに質問（解消するまで繰り返し）
  2. 既存の類似実装パターン調査
  3. 修正対象ファイルの特定
  4. 実装方針の策定
```

### 2-2. 実装計画の出力フォーマット

Planサブエージェントは以下の形式で出力すること：

```markdown
## 実装計画

### 1. 概要
- **目的**: （実装の目的を1-2文で）
- **スコープ**: （対象範囲を明確に）
- **除外事項**: （今回対象外とするもの）

### 2. 前提条件
- （実装に必要な前提条件を箇条書き）

### 3. 修正対象ファイル

| ファイルパス | 変更種別 | 変更概要 |
|-------------|---------|---------|
| path/to/file1.kt | 修正 | メソッド追加 |
| path/to/file2.kt | 新規 | 新規クラス作成 |

### 4. 実装ステップ

#### Step 1: （ステップ名）
- **対象ファイル**: path/to/file.kt
- **変更内容**:
  - （具体的な変更内容を箇条書き）
- **依存関係**: （他のステップとの依存があれば記載）

### 5. 類似実装の参照
- **参照ファイル**: path/to/reference.kt
- **参照理由**: （なぜこのファイルを参照するか）
- **踏襲するパターン**: （どのパターンを踏襲するか）

### 6. リスク・注意点
- （実装時の注意点を箇条書き）

### 7. メリット・デメリット

**この計画のメリット**:
- （メリットを箇条書き）

**この計画のデメリット**:
- （デメリットを箇条書き）

### 8. 代替案（あれば）
- （検討した代替案とその理由）
```

### 2-3. ユーザー承認

1. 実装計画をユーザーに提示
2. 以下の観点で承認を求める：
   - スコープは適切か
   - 修正対象ファイルは正しいか
   - 実装ステップは妥当か
   - リスク・注意点に漏れはないか

3. 承認されない場合:
   - フィードバックを受け取る
   - 2-1に戻り、計画を修正
   - 再度承認を求める

4. 承認された場合:
   - Phase 3へ進む

---

## Phase 3: 実装

```
Phase 3 チェックリスト：
- [ ] code-implementer サブエージェントの呼び出し
- [ ] コード実装完了
- [ ] ビルド成功確認
- [ ] 実装結果の確認
- [ ] 変更ファイル一覧の記録
```

### 3-1. code-implementer サブエージェントの呼び出し

Taskツールで `code-implementer` サブエージェントを起動：

```
subagent_type: "code-implementer"
prompt: |
  以下の実装計画に従ってコードを実装してください。

  ## 承認された実装計画
  {Phase 2で承認された計画}

  ## 修正対象ファイル
  {ファイルパスのリスト}

  ## プロジェクト規約
  CLAUDE.md: {パス}
```

**サブエージェントが実行するタスク**:
- 実装計画に従ったコード実装
- ビルド実行・エラー修正
- 実装完了の報告

### 3-2. 実装結果の確認

- サブエージェントからの報告を確認
- 問題があれば再度サブエージェントに指示

---

## Phase 4: テスト

```
Phase 4 チェックリスト：
- [ ] テスト必要性の判定
- [ ] （テスト必要時）test-writer サブエージェントの呼び出し
- [ ] （テスト必要時）テスト計画のユーザー承認
- [ ] （テスト必要時）テストコード実装完了
- [ ] （テスト必要時）テスト実行成功確認
```

### 4-1. テスト必要性の判定

以下の基準でテストの必要性を判定：

**テスト不要の条件**:
- 追加メソッドが既存共通クラスの呼び出しのみ
- 既存テストで十分にカバーされている
- UIの軽微な変更のみ

**テスト必要の条件**:
- 新規ビジネスロジックの追加
- 複雑な条件分岐の追加
- 外部API連携の追加

### 4-2. test-writer サブエージェントの呼び出し（テスト必要時のみ）

Taskツールで `test-writer` サブエージェントを起動：

```
subagent_type: "test-writer"
prompt: |
  以下のコードに対してテストを作成してください。

  ## テスト対象
  {Phase 3で実装したコードのパス}

  ## テスト要件
  - カバレッジ目標: 90%
  - テストフレームワーク: {プロジェクトで使用しているもの}

  ## プロジェクト規約
  CLAUDE.md: {パス}
```

**サブエージェントが実行するタスク**:
- テストコード実装計画の作成
- ユーザー承認の取得
- テストコードの実装
- テスト実行・修正

---

## Phase 5: 完了処理

```
Phase 5 チェックリスト：
- [ ] 全Phaseの完了確認
- [ ] 総評の作成
- [ ] 完了報告
```

### 5-1. 最終確認

- 全Phaseの完了を確認
- TodoWriteで全項目がcompletedになっていることを確認

### 5-2. 総評の作成

以下の観点でプロンプト改善提案を行う：

```markdown
## 総評

### 今回のタスクでうまくいった点
- （うまくいった点を箇条書き）

### 改善が必要だった点
- （改善点を箇条書き）

### プロンプトへの修正提案（あれば）
- （具体的な修正提案）
```

---

## 注意事項

- テストコードの生成はPhase 4で別途対応（Phase 2の計画には含めない）
- 過剰な改善提案は避け、要求されたスコープに集中する
- 既存コードのスタイルを尊重する
